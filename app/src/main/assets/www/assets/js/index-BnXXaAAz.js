import{Q as a,S as e,r as l,c as s,a as t,b as o,d as n,l as u,I as d,J as i,K as c,L as r,O as p,u as v,j as m,M as y,F as h,P as C,R as A,ai as E,x as b}from"./vue-vendor-dpeM2kxB.js";import{_ as O,c as R,b6 as f,b7 as _,b as L,ax as P,af as N,aW as S,b8 as T,b9 as M,ba as D,R as w,E as g,t as I,aR as U,d as V,bb as Y,aQ as B,ae as k}from"./main-UPGOfi6h.js";import{C as x}from"./CouponCard-ChD-cgEg.js";import"./utils-vendor-Bv3pXXA2.js";import"./vant-vendor-CCYRvjqt.js";import"./pdfh5-DcFc6bYW.js";const H={class:"prop-trader-pay-order"},$={class:"pay-order-container"},j={class:"content-wrapper"},F={class:"order-card"},W={class:"order-status"},z={class:"status-content"},G={class:"status-title"},q=["innerHTML"],K={class:"order-details"},Q={class:"detail-item"},J={class:"label"},Z={class:"value"},X={class:"detail-item"},aa={class:"label"},ea={class:"value highlight"},la={class:"detail-item"},sa={class:"label"},ta={class:"value"},oa={class:"detail-item"},na={class:"label"},ua={class:"value"},da={class:"detail-item"},ia={class:"label"},ca={class:"value highlight"},ra={class:"detail-item"},pa={class:"label"},va={class:"value"},ma={class:"detail-item"},ya={class:"label"},ha={class:"value"},Ca={class:"coupon-option-content"},Aa={class:"payment-amount"},Ea={class:"amount-value"},ba=O(Object.assign({name:"PropTraderPayOrder"},{__name:"index",setup(O){const{t:ba}=R(),Oa=a(),Ra=e(),fa=l([]),_a=l([]),La=f(),Pa=_(),Na=L(),Sa=P(),Ta=N(),Ma=S(),{isApp:Da,packageName:wa}=Ma,ga=l([]),Ia=s((()=>0===Number(Ka.value)?ga.value.filter((a=>0===a.type)):Da&&"com.prop.vebson"===wa?ga.value.filter((a=>1!==a.type)):ga.value)),Ua=s((()=>"free-trial"===sessionStorage.getItem("account_type"))),Va=t({paymentMethod:void 0,wayCode:"",couponsIds:[]}),Ya=s((()=>"billing"===Ra.query.from)),Ba=s((()=>"reset"===Ra.query.from)),ka=s((()=>1===Fa.value.isResetOrder)),xa=s((()=>{var a;if(Fa.value.price<10)return[];const e=((null==(a=Ta.myCoupons)?void 0:a.data)||[]).filter((a=>{if(a.applicableProduct){return a.applicableProduct.split(",").map(Number).includes(Fa.value.balance)}return a.accountSize===Fa.value.balance})),l=fa.value.some((a=>0===a.overlayState));return e.map((a=>{const e=fa.value.some((e=>e.id===a.id)),s=l&&!e;return{label:a.displayText,value:a.id,coupon:a,disabled:s}}))})),Ha=async()=>{await(async()=>{var a;try{const e=await B();(null==(a=null==e?void 0:e.data)?void 0:a.length)&&(ga.value=e.data.map((a=>{let e=a.paymentMethodsName;return 0===a.paymentMethods?e=`${a.paymentMethodsName} (Balance: ${a.balance})`:2===a.paymentMethods&&(e=`${a.paymentMethodsName} (Limit ${a.limits} PKR)`),{label:a.paymentMethodsName,sheetLabel:e,value:a.paymentMethods,type:a.paymentMethods,wayCode:a.wayCode}})))}catch(e){}})();let a=null;if(0===Number(Ka.value)||Da&&"com.prop.vebson"===wa?(a=Ia.value.find((a=>0===a.type)),a?(Va.paymentMethod=a.value,Va.wayCode=a.wayCode||""):(Va.paymentMethod=0,Va.wayCode="")):Ia.value.length>0&&(a=Ia.value[0],Va.paymentMethod=a.value,Va.wayCode=a.wayCode||""),Ya.value){if(!Na.orderData)return void Oa.replace({name:w.PC.PROP_TRADER_BILLING})}else if(Ba.value){if(!Na.orderData)return void Oa.replace({name:w.PC.ACCOUNTS_OVERVIEW})}else{if(!(Ua.value?Pa:La).accountData)return}Ba.value||ka.value||await(async()=>{try{const a=await Ta.fetchMyCoupons({page:1,limit:9999,state:k.VALID});Ta.$patch({myCoupons:a})}catch(a){}})()};o((async()=>{await Ha(),T(M,Qa)})),n((async()=>{Fa.value.id||await Ha()})),u((()=>{D(M,Qa)}));const $a=(a,e)=>`${a}-${e}`,ja=s({get:()=>$a(Va.paymentMethod,Va.wayCode),set(a){}}),Fa=s((()=>{if(Ya.value||Ba.value)return Na.orderData||{};return(Ua.value?Pa:La).accountData||{}})),Wa=a=>{const e=a.split("-"),l=Number(e[0]),s="undefined"===e[1]?"":e[1];Va.paymentMethod=l,Va.wayCode=s||""},za=a=>{const e=[];for(const l of a){const a=xa.value.find((a=>a.value===l));if(a&&!a.disabled){if(0===a.coupon.overlayState){e.length=0,e.push(a.coupon),_a.value=[l];break}e.some((a=>0===a.overlayState))||e.push(a.coupon)}}fa.value=e,Va.couponsIds=e.map((a=>a.id))},Ga=l(!1),qa=async()=>{if(!Ga.value)try{if(Ga.value=!0,!Ya.value&&Ua.value)return void Oa.push({name:w.PC.ACCOUNTS_OVERVIEW});if(0===Number(Ka.value)){const a=Ia.value.find((a=>0===a.type));a?(Va.paymentMethod=a.value,Va.wayCode=a.wayCode||""):(Va.paymentMethod=0,Va.wayCode="")}if(0!==Va.paymentMethod&&!Va.paymentMethod)return void g.warning(ba("PAY_ORDER.LABELS.PAYMENT_METHOD"));const e={id:Fa.value.id,paymentMethods:Va.paymentMethod,couponsIds:Va.couponsIds,wayCode:Va.wayCode},l=await Sa.confirmPay(e);if(0===e.paymentMethods)if(1===l.isNeedPopup){I(U.PAY_SUCCESS_CONGRATULATION);try{await V({login:l.login})}catch(a){}}else Oa.push({name:w.PC.ACCOUNTS_OVERVIEW});else{if(!l.payLink)throw new Error("Payment link not found");if(0===l.linkType)return void(await Y(l.payLink,!0));if(1===l.linkType)return void(3===e.paymentMethods?Oa.push({name:w.LOCAL_TRANSFER,query:{id:Fa.value.id,amount:Ka.value}}):Oa.push({name:w.LOCAL_TRANSFER,amount:Ka.value}));Oa.push({name:w.PC.ACCOUNTS_OVERVIEW})}}catch(a){g.error(a.message||"Payment failed"),0===Va.paymentMethod&&"1003"===a.code&&Oa.push({name:w.ADD_DEPOSIT_FUNDS})}finally{Ga.value=!1}},Ka=s((()=>{if(0===fa.value.length)return Fa.value.price;const a=fa.value.reduce(((a,e)=>a*e.discountRate),1),e=Fa.value.price*a;return Math.max(e,0).toFixed(2)})),Qa=()=>{Oa.push({name:w.PC.ACCOUNTS_OVERVIEW})},Ja=s((()=>0===xa.value.length?ba("ADD_CHALLENGE.NO_COUPONS_AVAILABLE"):ba("PAY_ORDER.VALUES.CHOOSE")));return(a,e)=>{const l=d("el-option"),s=d("el-select"),t=d("el-button");return i(),c("div",H,[r("div",$,[e[5]||(e[5]=r("div",{class:"page-header"},null,-1)),r("div",j,[r("div",F,[r("div",W,[e[3]||(e[3]=r("div",{class:"status-icon"},[r("svg",{viewBox:"64 64 896 896",focusable:"false","data-icon":"check-circle",fill:"currentColor","aria-hidden":"true"},[r("path",{d:"M699 353h-46.9c-10.2 0-19.9 4.9-25.9 13.3L469 584.3l-71.2-98.8c-6-8.3-15.6-13.3-25.9-13.3H325c-6.5 0-10.3 7.4-6.5 12.7l124.6 172.8a31.8 31.8 0 0051.7 0l210.6-292c3.9-5.3.1-12.7-6.4-12.7z"}),r("path",{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"})])],-1)),r("div",z,[r("h2",G,p(v(ba)("PAY_ORDER.STATUS.TITLE")),1),r("p",{class:"status-description",innerHTML:v(ba)("PAY_ORDER.STATUS.DESCRIPTION")},null,8,q)])]),r("div",K,[r("div",Q,[r("span",J,p(v(ba)("PAY_ORDER.LABELS.ORDER_NUMBER")),1),r("span",Z,p(Fa.value.proformaNo),1)]),r("div",X,[r("span",aa,p(v(ba)("PAY_ORDER.LABELS.ACCOUNT_SIZE")),1),r("span",ea,"$"+p(Fa.value.balance),1)]),r("div",la,[r("span",sa,p(v(ba)("PAY_ORDER.LABELS.ACCOUNT_TYPE")),1),r("span",ta,p(Fa.value.accountType),1)]),r("div",oa,[r("span",na,p(v(ba)("PAY_ORDER.LABELS.PLATFORM")),1),r("span",ua,p(v(ba)("PAY_ORDER.VALUES.PLATFORM")),1)]),r("div",da,[r("span",ia,p(v(ba)("PAY_ORDER.LABELS.TRADING_ACCOUNT_CURRENCY")),1),r("span",ca,p(Fa.value.tradingAccountCurrency),1)]),r("div",ra,[r("span",pa,p(v(ba)("PAY_ORDER.LABELS.PAYMENT_METHOD")),1),r("div",va,[m(s,{modelValue:ja.value,"onUpdate:modelValue":e[0]||(e[0]=a=>ja.value=a),placeholder:v(ba)("PAY_ORDER.VALUES.CHOOSE"),class:"payment-select",placement:"bottom-end",onChange:Wa},{default:y((()=>[(i(!0),c(h,null,C(Ia.value,(a=>(i(),A(l,{key:$a(a.value,a.wayCode),label:a.sheetLabel,value:$a(a.value,a.wayCode)},null,8,["label","value"])))),128))])),_:1},8,["modelValue","placeholder"])])]),r("div",ma,[r("span",ya,p(v(ba)("PAY_ORDER.LABELS.COUPON")),1),r("div",ha,[m(s,{modelValue:_a.value,"onUpdate:modelValue":e[2]||(e[2]=a=>_a.value=a),placeholder:Ja.value,"no-data-text":v(ba)("ADD_CHALLENGE.NO_COUPONS_AVAILABLE"),class:"coupon-select",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","popper-class":"coupon-select-dropdown no-check-icon",placement:"bottom-end",onChange:za},{default:y((()=>[(i(!0),c(h,null,C(xa.value,(a=>(i(),A(l,{key:a.value,label:a.label,value:a.value,disabled:a.disabled},{default:y((()=>[r("div",Ca,[m(x,{coupon:a.coupon,"is-active":_a.value.includes(a.value),disabled:a.disabled,class:"mini-coupon-card",onClick:e[1]||(e[1]=E((()=>{}),["stop"]))},null,8,["coupon","is-active","disabled"])])])),_:2},1032,["label","value","disabled"])))),128))])),_:1},8,["modelValue","placeholder","no-data-text"])])])]),r("div",Aa,[e[4]||(e[4]=r("div",{class:"amount-label"},"To be paid",-1)),r("div",Ea,"$"+p(Ka.value),1)])]),m(t,{type:"primary",size:"large",class:"pay-button",loading:Ga.value,disabled:Ga.value,onClick:qa},{default:y((()=>[b(p(v(ba)("PAY_ORDER.BUTTON.PAY")),1)])),_:1},8,["loading","disabled"])])])])}}}),[["__scopeId","data-v-50bb0285"]]);export{ba as default};
